{% if count != 0 %}
    <style>
        .finger {
            cursor: pointer;
        }

        .cross {
            cursor: crosshair;
        }

        .progress {
            cursor: progress;
        }


        .help {
            cursor: help;
        }
    </style>


    <style>
        td {
            vertical-align: top;
            horiz-align: left;
            padding-left: 5px;
            padding-right: 5px;
        {#padding-bottom: 10px;#} padding-top: 10px;
        {#padding-top: 1px;#}{#padding-bottom: 1px;#}
        }

        textarea {
            padding-top: 2px;
        }

        .div-float-button-1 {

            top: 100px;
            left: 100px;
            width: 42px;
            height: 64px;
            z-index: 2;

        }

        .btnMy {
            width: 24px;
            height: 24px;
            border-style: none;
            font-size: small;

            padding-bottom: 2px;
            background-color: #E3F2FD;

        }

        .tdNoBord {
            background-color: white;
            border-top-color: white;
            border-right-color: white;
            border-bottom-color: white;

        }

        .contentN {
            alignment: center;
        }

    </style>

    <script type="text/javascript">
        var oldArrea;
        var n;
        var plantable;
        var rtable;
        {#alert(n);#}
    </script>
    <div id="pnl" style="background-color: #E3F2FD">


        <form id="update-form" method="post"> {% csrf_token %}
            {% if plans|length > 0 %}
                <table border="1" style="border-style: none ; border-color: white;">
                    <tr name="header">
                        <td style="width: 3%;"><b>№</b></td>
                        <td hidden></td>
                        <td hidden></td>
                        <td style="width: 50%;"><b>Зміст роботи</b></td>
                        <td style="width: 10%;"><b>Строки виконання</b></td>
                        <td style="width: 10%;"><b>Форма узагальнення</b></td>
                        <td style="width: 20%;"><b>Відповідальні</b></td>
                        <td style="width: 7%;"><b>Примітка</b></td>
                        <td hidden>Сортування</td>
                        <td class="tdNoBord"></td>
                    </tr>
                    {% for plan in plans %}

                        <tr id="r{{ plan.id }}" class="{{ forloop.counter }}">
                            <td id="i{{ plan.id }}" class="contentN" name="N"
                                onclick="editField('i{{ plan.id }}')"
                                title="id={{ plan.id }}">
                                {{ forloop.counter }}

                            </td>
                            <td id="d{{ plan.id }}" hidden class="content" name="direction_id"><input type="text"
                                                                                                      name="direction_id"/>
                            </td>
                            <td id="p{{ plan.id }}" hidden class="content" name="purpose_id"><input type="text"
                                                                                                    name="purpose_id"/>
                            </td>

                            <td id="c{{ plan.id }}" class="content" name="content"
                                onclick="editField('c{{ plan.id }}')">
                                <p style="white-space: pre-line;">
                                    {{ plan.content }}
                                </p>
                                {#                            <textarea style="border: none;" cols="80" >#}
                                {#                            {{ plan.content}}#}
                                {#                            </textarea>#}
                            </td>
                            <td id="t{{ plan.id }}" class="content" name="termin"
                                onclick="editField('t{{ plan.id }}')">{{ plan.termin }}</td>
                            <td id="g{{ plan.id }}" class="content" name="generalization"
                                onclick="editField('g{{ plan.id }}')">{{ plan.generalization }}</td>
                            <td id="r{{ plan.id }}" class="content" name="responsible"
                                onclick="editField('r{{ plan.id }}')">{{ plan.responsible }}</td>
                            <td id="n{{ plan.id }}" class="content" name="note"
                                onclick="editField('n{{ plan.id }}')">{{ plan.note }}</td>
                            <td id="s{{ plan.id }}" class="content" name="sort">{{ plan.sort }}</td>
                            <td id="b{{ plan.id }}" name="N" class="contentBtn tdNoBord">
                                <button class="btnMy" id="up__{{ plan.id }}" type="button" title="Вгору"
                                        onclick="btnClick('up__{{ plan.id }}');">
                                    &#8593;
                                </button>
                                <button class="btnMy" id="add_{{ plan.id }}" type="button" title="Додати"
                                        onclick="btnClickAdd('add_{{ plan.id }}');">+
                                </button>
                                <button class="btnMy" id="down{{ plan.id }}" type="button" title="Вниз"
                                        onclick="btnClick('down{{ plan.id }}');">
                                    &#8595;
                                </button>
                                <p></p>
                                <button class="btnMy" id="down{{ plan.id }}" type="button" title="Вилучити"
                                        onclick="btnClick('del_{{ plan.id }}');">
                                    -
                                </button>
                                <p></p>
                                &nbsp;<input class="chb" id="ch_b{{ plan.id }}" type="checkbox"/>

                            </td>
                            <script type="text/javascript">
                                plantable = String(0{{ plan.plantable_id_id }});
                                rtable = "{{ plan.r_id }}";
                                console.log("->" + rtable);
                            </script>
                        </tr>

                    {% endfor %}
                </table>
            {% endif %}
        </form>

    </div>

{% endif %}

<script type="text/javascript">


    function goEdit(e) {
        {#console.log("Зайшов у goEdit");#}


        if ((oldArrea == undefined)) {
            nam = jQuery(e).attr('name');
            text = jQuery(e).text().trim();
            w = jQuery(e).outerWidth(true);
            h = jQuery(e).outerHeight(true);
            jQuery(e).html('<textarea name="' + nam + '"  cols="' + String(parseInt(w / 8) + 10) + '" rows = "' + String(parseInt(h / 28) + 2) + '"> ' + text + '</textarea> ');
            oldArrea = jQuery(e);
        } else {

            {#console.log("Зайшов");#}


            if (oldArrea.attr("id") != jQuery(e).attr("id")) {
                w = jQuery(e).outerWidth(true)
                h = jQuery(e).outerHeight(true);

                //Тут зберігаємо за допомогою Ajax
                id = parseInt(oldArrea.parent('tr').attr('id').substring(1));
                nam = oldArrea.attr('name');

                var map = new Object();
                map = {
                    'id': 1,
                    'direction_id': 2,
                    'purpose_id': 3,
                    'content': 4,
                    'termin': 5,
                    'generalization': 6,
                    'responsible': 7,
                    'note': 8,
                    'sort': 9,
                };

                var data = $("#update-form").serialize();
                $.ajax({
                        url: "../rib_update_plan/" + id + "/" + map[nam] + "/",
                        type: "POST",
                        data: data,
                        error: function () {
                            console.log("Щось не те");
                        },
                        success: function () {
                            console.log("Все Ok");
                        }
                    }
                );
                text = oldArrea.find('textarea').val();
                text = text.trim();
                {#console.log(text);#}
                {#text = oldArrea.text();#}
                oldArrea.text(text);

                nam = jQuery(e).attr('name');
                if (nam != "N") {

                    text = jQuery(e).text().trim();
                    jQuery(e).html('<textarea name="' + nam + '"  cols="' + String(parseInt(w / 8) + 10) + '" rows = "' + String(parseInt(h / 28) + 2) + '"> ' + text + '</textarea> ');
                    oldArrea = jQuery(e);
                } else {
                    oldArrea = undefined;
                }

            }
        }
    }

    function editField(id) {
        //Знайти за id посилання на обєкт td
        e = jQuery('#' + id);
        tr = jQuery('#r' + id.substring(1));
        jQuery('tr').each(function (index, value) {
            jQuery(this).removeAttr('style');

        });

        tr.attr('style', 'background-color:  #86cfda;')

        console.log(tr);
        console.log('============');
        if (e.attr('name') == 'N') {
            if (oldArrea != undefined) {
                text = oldArrea.find('textarea').val();
                text = text.trim();
                oldArrea.text(text);
                console.log(oldArrea.parent('tr'));
                {#oldArrea.parent('tr').removeAttr('style');#}
            }
            oldArrea = undefined;
        } else {
            goEdit(e);
        }


        {#console.log(e);#}

    }


    jQuery.fn.swap = function (b) {
        b = jQuery(b)[0];
        var a = this[0],
            a2 = a.cloneNode(true),
            b2 = b.cloneNode(true),
            stack = this;

        a.parentNode.replaceChild(b2, a);
        b.parentNode.replaceChild(a2, b);

        stack[0] = a2;
        return this.pushStack(stack);
    };


    function btnClickAdd(id) {
        //Додати елемент знизу

        {#tr_next = jQuery('#' + id).parent().parent().next();#}

        tr_this = jQuery('#' + id).parent().parent();
        tr_next = tr_this.next();

        {#console.log(id);#}
        {#console.log(tr_this.html());#}
        {#console.log(tr_next.html());#}

        tr_this_id = tr_this.attr('id');
        tr_next_id = tr_next.attr('id');
        console.log("tr_next_id");
        console.log(tr_next_id);

        suff = 's';
        this_id = tr_this_id.substring(1);
        sortThis = tr_this.children('#' + suff + this_id).text();
        th = parseFloat(sortThis.replace(',', '.'));
        if (tr_next_id != undefined) {

            next_id = tr_next_id.substring(1);
            sortNext = tr_next.children('#' + suff + next_id).text();
            ne = parseFloat(sortNext.replace(',', '.'));
        } else {
            {#console.log("-undefined-");#}
            ne = th + 2;
        }
        av = (th + ne) / 2;
        sort = String(av).replace('.', ',');
        {#console.log(sortThis);#}
        {#console.log(sortNext);#}
        {#console.log(sort);#}


        tr_this.after('<tr id="newRow" style="background-color: red;">' +
            '                        <td class="contentN" name="N" style="width: 3%;color:white;">new</td>' +
            '                        <td hidden class="content" name="direction_id"></td>' +
            '                        <td hidden hidden class="content" name="purpose_id"></td>' +
            '                        <td  class="content" name="content"><textarea  id="contNew" cols="80" rows = "2"></textarea> </td>' +
            '                        <td  class="content" name="termin"><textarea  id="termNew"  cols="10" rows = "2"></textarea> </td>' +
            '                        <td  class="content" name="generalization"><textarea  id="genNew"  cols="10" rows = "2"></textarea> </td>' +
            '                        <td  class="content" name="responsible"><textarea  id="respNew"  cols="20" rows = "2"></textarea> </td>' +
            '                        <td  class="content" name="note"><textarea  id="noteNew"  cols="10" rows = "2"></textarea> </td>' +
            '                        <td  class="content" name="sort"   id="sortNew" >' + sort + '</td>' +
            '                        <td  name="N" class="contentBtn tdNoBord">' +
            '                           <button class="btnMy" type="button" onclick="SaveNew();">+</button>' +
            '                           <textarea  id="plantableNew" hidden >' + plantable + '</textarea>                ' +
            '                        </td>' +
            '                    </tr>');
        //Ставимо фокус ввода на Content
        jQuery('#contNew').focus();


    }


    //Збереження нового запису
    function SaveNew() {
        content_ = jQuery('#contNew').val();
        termin_ = jQuery('#termNew').val();
        generalization_ = jQuery('#genNew').val();
        responsible_ = jQuery('#respNew').val();
        sort_ = jQuery('#sortNew').text();
        note_ = jQuery('#noteNew').val();

        {#console.log(sort_);#}

        {#var data = $("#update-form").serialize();#}

        $.ajax({
                url: "../rib_add_plan/",
                type: "POST",
                cache: false,
                {#data: data,#}
                data: {
                    content: content_,
                    termin: termin_,
                    generalization: generalization_,
                    responsible: responsible_,

                    sort: sort_,
                    note: note_,
                    plantable: plantable,
                    rtable: rtable,


                },
                error: function () {
                    console.log("Щось не те");
                },
                success: function () {
                    {#console.log("Все Ok");#}
                    //З textarea переносимо до td
                    a = jQuery('#exampleFormControlSelect2').find(":selected").attr('id');

                    s = "" + a + "/";
                    {#console.log("s->  "+s);#}
                    jQuery('#pl').load(s);


                }
            }
        );

    }


    function btnClick(id) {
        var listId = [];

        suff = id.substring(0, 4);

        console.log(suff);
        console.log(jQuery('#ch_b' + id.substring(4)));
        jQuery('#ch_b' + id.substring(4)).attr('checked', true);


        jQuery('tr').each(function (index, value) {
            //Проходимо по таблиці, і там, де
            if (jQuery(this).find('.chb').is(':checked')) {
                id_ = jQuery(this).find('.chb').attr('id');
                id_ = suff + id_.substring(4);
                {#console.log(id_);#}
                listId.push(id_);
            }
        });
        if (suff == 'down') {
            listId.reverse();
        }


        console.log(listId);

        listId.forEach(function (item, i) {
            {#console.log(item);#}
            btnClick0(item)
        });


    }


    function btnClick0(id) {

        {#console.log("Зайшов до обробника кнопок");#}
        {#console.log('#'+id);#}

        tr_prev = jQuery('#' + id).parent().parent().prev();
        tr_this = jQuery('#' + id).parent().parent();
        tr_next = jQuery('#' + id).parent().parent().next();

        console.log(tr_prev.prev().attr('name'));

        tr_this_id = tr_this.attr('id');
        tr_next_id = tr_next.attr('id');
        tr_prev_id = tr_prev.attr('id');

        id_prev = tr_prev.attr('id');
        if (id_prev != undefined) {
            id_prev = id_prev.substring(1);
        }


        id_this = tr_this.attr('id');
        if (id_this != undefined) {
            id_this = id_this.substring(1);
        }
        id_next = tr_next.attr('id');
        if (id_next != undefined) {
            id_next = id_next.substring(1);
        }
        prev_Sort = tr_prev.find('#s' + id_prev).text();
        this_Sort = tr_this.find('#s' + id_this).text();
        next_Sort = tr_next.find('#s' + id_next).text();


        oldNum = jQuery('#' + id).parent().parent().find('#i' + id_this).text();
        oldNum = oldNum.trim();

        {#    Міняємо місцями елементи#}
        {#   https://smartideal.net/kak-pomenyat-dva-bloka-mestami/   #}
        idBtn = jQuery('#' + id).attr('id');
        if (idBtn != undefined) {
            idBtn = idBtn.substring(0, 4);
        }
        if ((idBtn == 'down')) {
            //Якщо елемент не останній

            //Міняємо поле sort місцями
            tr_next.find('#s' + id_next).text(this_Sort);
            tr_this.find('#s' + id_this).text(next_Sort);
            //Міняємо елементи місцями
            jQuery('#' + tr_this_id).swap(jQuery('#' + tr_next_id));
            // і прокрутить вгору на висоту даної комірки щоб мишка залишилася над полем, яке рухаємо

            y0 = jQuery('html').scrollTop();
            dy = jQuery('#' + id).parent().parent().next().outerHeight(true);
            destenation = y0 + dy;
            jQuery('html').animate({scrollTop: destenation}, 600);

            //Зберігаємо
            adj_for_sort(id_next, this_Sort);
            adj_for_sort(id_this, next_Sort);
        }

        if ((idBtn == 'up__')) {
            //Якщо елемент не останній

            //Міняємо поле sort місцями
            tr_prev.find('#s' + id_prev).text(this_Sort);
            tr_this.find('#s' + id_this).text(prev_Sort);
            //Міняємо елементи місцями
            jQuery('#' + tr_this_id).swap(jQuery('#' + tr_prev_id));
            // і прокрутить вниз на висоту даної комірки щоб мишка залишилася над полем, яке рухаємо

            y0 = jQuery('html').scrollTop();
            dy = jQuery('#' + id).parent().parent().prev().outerHeight(true);
            destenation = y0 - dy;
            jQuery('html').animate({scrollTop: destenation}, 600);

            //Зберігаємо
            adj_for_sort(id_prev, this_Sort);
            adj_for_sort(id_this, prev_Sort);

        }
        {#console.log(tr_this.html());#}

    }

    function adj_for_sort(id, sort0) {
        $.ajax({
                url: "../rib_update_plan/" + id + "/9/",
                type: "POST",
                cache: false,
                data: {
                    sort: sort0
                },
                error: function () {
                    console.log("Щось не те");
                },
                success: function () {
                    console.log("Все Ok");
                }
            }
        );
    }


</script>





